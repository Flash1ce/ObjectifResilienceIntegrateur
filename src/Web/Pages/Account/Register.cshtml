@page
@using Gwenael.Web.Pages.Account
@model Gwenael.Web.Pages.Account.RegisterModel
@{
    ViewData["Title"] = "Inscription";
}

<!-- Entête de la page (Titre + btn retour) -->
<nav class="navbar navbar-light shadow-sm">
    <div class="container-fluid">
        <h1>@ViewData["Title"]</h1>
    </div>
</nav>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-4">
            <br />
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <form method="post" name="demo-test" id="form-register">
                        <h3>Demande d'inscription</h3>
                        <div class="msgSucceeded">
                            @if (ViewData["msgSucceeded"] is not null)
                            {
                                <div class="alert alert-primary" role="alert">@ViewData["msgSucceeded"]</div>
                            }
                        </div>
                        <p style="text-align:center;">Votre demande sera traitée dans les plus brefs délais.</p>
                        <div class="text-danger"></div>
                        <div class="form-group">
                            <br />
                            <input type="text" class="form-control" placeholder="Courriel" aria-label="Courriel" name="courriel" id="courriel">
                            <span class="text-danger" id="msgErreurCourriel"></span>
                        </div>
                        <div class="form-group">
                            <input class="form-control" placeholder="Mot de passe" aria-label="Mot de passe" type="password" name="password" id="password">
                            <span class="text-danger" id="msgErreurPassword"></span>
                            <span class="text-danger" id="msgErreurPasswordLength"></span>
                        </div>
                        <div class="form-group">
                            <input class="form-control" placeholder="Confirmation du mot de passe" aria-label="Confirmation du mot de passe" type="password" name="confPassword" id="confPassword">
                            <span class="text-danger" id="msgErreurConfPassword"></span>
                            <p>Vous avez déjà un compte ?  <a asp-page="/Account/Login">Connectez-vous !</a></p>
                        </div>
                        <div class="form-group" style="display:flex; justify-content:end;">
                            <button type="submit" class="btn btn-outline-primary">Envoyer la demande d'inscription</button>
                        </div>
                        <button class="g-recaptcha"
                                data-sitekey="6LfPBWYfAAAAAAGXpazSjwWTSPW_o1zbRahvvHVE"
                                data-callback='onSubmit'
                                data-action='submit'
                                data-registerRequest>
                            Submit
                        </button>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://www.google.com/recaptcha/api.js"></script>


<script>
    function onSubmit(token) {
        document.getElementById("demo-test").submit();
    }

    $('[data-registerRequest]').on('click', event => {
        document.getElementById('msgErreurPassword').textContent = "";
        document.getElementById('msgErreurPasswordLength').textContent = "";
        document.getElementById('msgErreurConfPassword').textContent = "";
        document.getElementById('msgErreurCourriel').textContent = "";
        if (document.getElementById('password').value != "" && document.getElementById('confPassword').value != "" && document.getElementById('courriel').value != "") {
            $.ajax({
                type: 'POST',
                url: window.location.pathname,
                async: false,
                data: new FormData(document.getElementById('form-register')),
                headers: {
                    RequestVerificationToken:
                        $('input:hidden[name="__RequestVerificationToken"]').val()
                },
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.msgSuccess != null)
                    {
                        $('.msgSucceeded').append("<div class='alert alert-primary' role='alert'>" + data.msgSuccess + "</div>");
                        setTimeout(function () {
                            window.location.href = '/Index';
                        }, 10000);
                    }
                    else
                    {
                        if (data.erreurPassword != null) {
                            document.getElementById('msgErreurPassword').textContent = data.erreurPassword;
                            document.getElementById('msgErreurConfPassword').textContent = data.erreurPassword;
                        }
                        if (data.erreurCourriel != null) {
                            document.getElementById('msgErreurCourriel').textContent = data.erreurCourriel;
                        }
                    }
                },
                error: function () {
                    document.getElementById('msgErreurCourriel').textContent = "Ce courriel est déjà lié à un compte";
                }
            });
        }
        else {
            if (document.getElementById('password').value == "") {
                document.getElementById('msgErreurPassword').textContent = "Le champ ne peut pas être vide.";
            }
            if (document.getElementById('confPassword').value == "") {
                document.getElementById('msgErreurConfPassword').textContent = "Le champ ne peut pas être vide.";
            }
            if (document.getElementById('courriel').value == "") {
                document.getElementById('msgErreurCourriel').textContent = "Le champ ne peut pas être vide.";
            }
        }
    });

</script>
